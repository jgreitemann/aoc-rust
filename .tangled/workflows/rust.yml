when:
  - event: ["push"]
    branch: ["main"]
  - event: ["pull_request"]
    branch: ["main"]

engine: "nixery"

dependencies:
  nixpkgs:
    - gcc
    - rustc
    - cargo
    - clippy
    - cargo-nextest
    - sccache

environment:
  RUSTC_WRAPPER: "sccache"
  SCCACHE_REDIS_ENDPOINT: "redis://172.17.0.1:6379"

steps:
  - name: "Build all projects"
    command: |
       cargo build --release --verbose --locked
  - name: "Clippy"
    command: |
       cargo clippy --release --workspace --locked
  - name: Run tests
    command: |
      cargo nextest run --release --locked
